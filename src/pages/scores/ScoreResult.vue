<!-- src/pages/ScoreResultPage.vue -->
<template>
    <div class="min-h-screen bg-white px-4 pt-20 pb-10 relative">
        <BackHeader title="Í∞ÄÏ†ê Í≥ÑÏÇ∞Í∏∞" />

        <!-- Ìó§ÎìúÎùºÏù∏ -->
        <h2 class="text-xl font-extrabold mb-6">ÎÇ¥ Ï£ºÌÉù Ï≤≠ÏïΩ ÏòàÏÉÅ Ï†êÏàò</h2>

        <!-- ÎßÅ Ï∞®Ìä∏ + Ï¥ùÏ†ê -->
        <div class="flex flex-col items-center mb-8">
            <div class="relative">
                <svg width="150" height="150">
                    <!-- Î∞∞Í≤Ω ÏÑúÌÅ¥ -->
                    <circle cx="75" cy="75" r="70" stroke="#eee" stroke-width="10" fill="none" />
                    <!-- ÏßÑÌñâÎèÑ ÏÑúÌÅ¥ -->
                    <circle
                        cx="75"
                        cy="75"
                        r="70"
                        stroke="#76C9F2"
                        stroke-width="10"
                        fill="none"
                        stroke-linecap="round"
                        :stroke-dasharray="circumference"
                        :stroke-dashoffset="circumference - (totalScore / maxTotal) * circumference"
                        transform="rotate(-90 75 75)"
                    />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-4xl font-extrabold">{{ totalScore }}</span>
                    <span class="text-sm text-gray-500">{{ maxTotal }}Ï†ê ÎßåÏ†ê</span>
                </div>
            </div>

            <!-- Ï†ïÎ≥¥ ÏàòÏ†ïÌïòÍ∏∞ Î≤ÑÌäº -->
            <button @click="goInfo" class="mt-4 text-sm text-blue-500 hover:underline">
                Ï†ïÎ≥¥ ÏàòÏ†ïÌïòÍ∏∞
            </button>
        </div>

        <!-- ÌååÌä∏Î≥Ñ Ï†êÏàò Î¶¨Ïä§Ìä∏ -->
        <ul class="divide-y divide-gray-200 mb-8">
            <!-- Î¨¥Ï£ºÌÉù Í∏∞Í∞Ñ -->
            <li class="flex justify-between items-center py-4">
                <div class="flex items-center gap-2">
                    <HomeIcon class="w-5 h-5 text-gray-600" />
                    <span>Î¨¥Ï£ºÌÉù Í∏∞Í∞Ñ Ï†êÏàò</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="font-semibold">{{ noHouseScore }}Ï†ê</span>
                    <span class="text-gray-500">/ 32Ï†ê</span>
                    <ChevronRightIcon
                        @click="openModal('noHouse')"
                        class="w-4 h-4 text-gray-400 ml-2 cursor-pointer"
                    />
                </div>
            </li>

            <!-- Î∂ÄÏñëÍ∞ÄÏ°± Ïàò -->
            <li class="flex justify-between items-center py-4">
                <div class="flex items-center gap-2">
                    <UsersIcon class="w-5 h-5 text-gray-600" />
                    <span>Î∂ÄÏñëÍ∞ÄÏ°± Ï†êÏàò</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="font-semibold">{{ familyScore }}Ï†ê</span>
                    <span class="text-gray-500">/ 35Ï†ê</span>
                    <ChevronRightIcon
                        @click="openModal('family')"
                        class="w-4 h-4 text-gray-400 ml-2 cursor-pointer"
                    />
                </div>
            </li>

            <!-- Ï≤≠ÏïΩÌÜµÏû• Í∞ÄÏûÖÍ∏∞Í∞Ñ -->
            <li class="flex justify-between items-center py-4">
                <div class="flex items-center gap-2">
                    <CalendarIcon class="w-5 h-5 text-gray-600" />
                    <span>Ï≤≠ÏïΩÌÜµÏû• Í∞ÄÏûÖÍ∏∞Í∞Ñ Ï†êÏàò</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="font-semibold">{{ accountScore }}Ï†ê</span>
                    <span class="text-gray-500">/ 17Ï†ê</span>
                    <ChevronRightIcon
                        @click="openModal('account')"
                        class="w-4 h-4 text-gray-400 ml-2 cursor-pointer"
                    />
                </div>
            </li>
        </ul>

        <!-- ÌôàÏúºÎ°ú Í∞ÄÍ∏∞ Î≤ÑÌäº -->
        <div class="px-4">
            <button
                @click="goHome"
                class="w-full py-3 bg-blue-500 text-white font-bold rounded-full shadow"
            >
                ÌôàÏúºÎ°ú Í∞ÄÍ∏∞
            </button>
        </div>

        <!-- üìå Ï†êÏàòÌëú Î™®Îã¨ -->
        <transition name="fade">
            <div
                v-if="modalVisible"
                class="fixed inset-0 z-50 flex items-end justify-center bg-black bg-opacity-40"
                @click.self="modalVisible = false"
            >
                <div
                    class="bg-white w-full max-w-md rounded-t-2xl p-4 pb-safe safe-bottom overflow-auto"
                >
                    <!-- Î™®Îã¨ Ìó§Îçî -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">{{ modalTitle }}</h3>
                        <button
                            @click="modalVisible = false"
                            class="text-gray-500 text-2xl leading-none"
                        >
                            √ó
                        </button>
                    </div>

                    <!-- ÌÉÄÏûÖÎ≥Ñ Ìëú Î†åÎçîÎßÅ -->
                    <div class="text-sm text-center">
                        <!-- Î¨¥Ï£ºÌÉù Í∏∞Í∞Ñ Ìëú -->
                        <table v-if="modalType === 'noHouse'" class="w-full table-fixed text-xs">
                            <tr class="bg-gray-50">
                                <th>Í∏∞Í∞Ñ</th>
                                <th>Ï†êÏàò</th>
                                <th>Í∏∞Í∞Ñ</th>
                                <th>Ï†êÏàò</th>
                            </tr>
                            <tr v-for="(row, i) in noHouseTable" :key="i">
                                <td class="py-2">{{ row.left.range }}</td>
                                <td :class="highlightClass('noHouse', row.left.score)">
                                    {{ row.left.score }}Ï†ê
                                </td>
                                <td class="py-2">{{ row.right.range }}</td>
                                <td :class="highlightClass('noHouse', row.right.score)">
                                    {{ row.right.score }}Ï†ê
                                </td>
                            </tr>
                        </table>

                        <!-- Î∂ÄÏñëÍ∞ÄÏ°± Ïàò Ìëú -->
                        <table v-if="modalType === 'family'" class="w-full table-fixed text-xs">
                            <tr class="bg-gray-50">
                                <th>Í∞ÄÏ°± Ïàò</th>
                                <th>Ï†êÏàò</th>
                                <th>Í∞ÄÏ°± Ïàò</th>
                                <th>Ï†êÏàò</th>
                            </tr>
                            <tr v-for="(row, i) in familyTable" :key="i">
                                <!-- ÏôºÏ™Ω -->
                                <td class="py-2">{{ row.left.count }}</td>
                                <td :class="highlightClass('family', row.left.score)">
                                    {{ row.left.score }}Ï†ê
                                </td>

                                <!-- Ïò§Î•∏Ï™Ω: Í∞íÏù¥ ÏûàÏùÑ ÎïåÎßå Ï∂úÎ†• -->
                                <template v-if="row.right.count && row.right.score !== null">
                                    <td class="py-2">{{ row.right.count }}</td>
                                    <td :class="highlightClass('family', row.right.score)">
                                        {{ row.right.score }}Ï†ê
                                    </td>
                                </template>
                                <!-- ÏóÜÏúºÎ©¥ colspan=2 -->
                                <template v-else>
                                    <td colspan="2"></td>
                                </template>
                            </tr>
                        </table>

                        <!-- ÌÜµÏû• Í∞ÄÏûÖÍ∏∞Í∞Ñ Ìëú -->
                        <table v-if="modalType === 'account'" class="w-full table-fixed text-xs">
                            <tr class="bg-gray-50">
                                <th>Í∏∞Í∞Ñ</th>
                                <th>Ï†êÏàò</th>
                                <th>Í∏∞Í∞Ñ</th>
                                <th>Ï†êÏàò</th>
                            </tr>
                            <tr v-for="(row, i) in accountTable" :key="i">
                                <!-- ÏôºÏ™Ω -->
                                <td class="py-2">{{ row.left.range }}</td>
                                <td :class="highlightClass('account', row.left.score)">
                                    {{ row.left.score }}Ï†ê
                                </td>

                                <!-- Ïò§Î•∏Ï™Ω -->
                                <template v-if="row.right.range && row.right.score !== null">
                                    <td class="py-2">{{ row.right.range }}</td>
                                    <td :class="highlightClass('account', row.right.score)">
                                        {{ row.right.score }}Ï†ê
                                    </td>
                                </template>
                                <template v-else>
                                    <td colspan="2"></td>
                                </template>
                            </tr>
                        </table>
                    </div>

                    <!-- Îã´Í∏∞ Î≤ÑÌäº -->
                    <button
                        @click="modalVisible = false"
                        class="mt-6 w-full py-3 border border-gray-300 rounded-full text-gray-700 font-medium"
                    >
                        ÌôïÏù∏
                    </button>
                </div>
            </div>
        </transition>
    </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useScoreStore } from '@/stores/scoreStore'
import BackHeader from '@/components/common/BackHeader.vue'
import {
    Home as HomeIcon,
    Users as UsersIcon,
    Calendar as CalendarIcon,
    ChevronRight as ChevronRightIcon,
} from 'lucide-vue-next'

const router = useRouter()
const scoreStore = useScoreStore()

onMounted(async () => {
    try {
        const res = await scoreStore.fetchScoreFromServer()
        await scoreStore.calculateScore()
        console.log('[ScoreResultPage] Ï†êÏàò Ï†ïÎ≥¥ ÏµúÏã†Ìôî ÏôÑÎ£å')
    } catch (e) {
        console.error('[ScoreResultPage] Ï†êÏàò Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', e)
    }
})

// Î™®Îã¨ ÏÉÅÌÉú
const modalVisible = ref(false)
const modalType = ref('') // 'noHouse' | 'family' | 'account'

// ÎßÅ Ï∞®Ìä∏ Í≥ÑÏÇ∞Ïö©
const totalScore = computed(() => scoreStore.result.total_ga_score || 0)
const maxTotal = 84
const circumference = 2 * Math.PI * 70

// ÌååÌä∏Î≥Ñ Ï†êÏàò
const noHouseScore = computed(() => scoreStore.result.no_house_score || 0)
const familyScore = computed(() => scoreStore.result.dependents_score || 0)
const accountScore = computed(() => scoreStore.result.payment_period_score || 0)

// Î™®Îã¨ Ïò§Ìîà
function openModal(type) {
    modalType.value = type
    modalVisible.value = true
}

// Î™®Îã¨ Ï†úÎ™©
const modalTitle = computed(() => {
    switch (modalType.value) {
        case 'noHouse':
            return 'Î¨¥Ï£ºÌÉù Í∏∞Í∞Ñ Ï†êÏàò'
        case 'family':
            return 'Î∂ÄÏñëÍ∞ÄÏ°± Ïàò Ï†êÏàò'
        case 'account':
            return 'Ï≤≠ÏïΩÌÜµÏû• Í∞ÄÏûÖÍ∏∞Í∞Ñ Ï†êÏàò'
        default:
            return ''
    }
})

// Ï†êÏàòÌëú Îç∞Ïù¥ÌÑ∞ (ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú)
const noHouseTable = [
    { left: { range: '1ÎÖÑ ÎØ∏Îßå', score: 2 }, right: { range: '8ÎÖÑ Ïù¥ÏÉÅ ~ 9ÎÖÑ ÎØ∏Îßå', score: 18 } },
    {
        left: { range: '1ÎÖÑ Ïù¥ÏÉÅ ~ 2ÎÖÑ ÎØ∏Îßå', score: 4 },
        right: { range: '9ÎÖÑ Ïù¥ÏÉÅ ~ 10ÎÖÑ ÎØ∏Îßå', score: 20 },
    },
    {
        left: { range: '2ÎÖÑ Ïù¥ÏÉÅ ~ 3ÎÖÑ ÎØ∏Îßå', score: 6 },
        right: { range: '10ÎÖÑ Ïù¥ÏÉÅ ~ 11ÎÖÑ ÎØ∏Îßå', score: 22 },
    },
    {
        left: { range: '3ÎÖÑ Ïù¥ÏÉÅ ~ 4ÎÖÑ ÎØ∏Îßå', score: 8 },
        right: { range: '11ÎÖÑ Ïù¥ÏÉÅ ~ 12ÎÖÑ ÎØ∏Îßå', score: 24 },
    },
    {
        left: { range: '4ÎÖÑ Ïù¥ÏÉÅ ~ 5ÎÖÑ ÎØ∏Îßå', score: 10 },
        right: { range: '12ÎÖÑ Ïù¥ÏÉÅ ~ 13ÎÖÑ ÎØ∏Îßå', score: 26 },
    },
    {
        left: { range: '5ÎÖÑ Ïù¥ÏÉÅ ~ 6ÎÖÑ ÎØ∏Îßå', score: 12 },
        right: { range: '13ÎÖÑ Ïù¥ÏÉÅ ~ 14ÎÖÑ ÎØ∏Îßå', score: 28 },
    },
    {
        left: { range: '6ÎÖÑ Ïù¥ÏÉÅ ~ 7ÎÖÑ ÎØ∏Îßå', score: 14 },
        right: { range: '14ÎÖÑ Ïù¥ÏÉÅ ~ 15ÎÖÑ ÎØ∏Îßå', score: 30 },
    },
    { left: { range: '7ÎÖÑ Ïù¥ÏÉÅ ~ 8ÎÖÑ ÎØ∏Îßå', score: 16 }, right: { range: '15ÎÖÑ Ïù¥ÏÉÅ', score: 32 } },
]

const familyTable = [
    { left: { count: '0Î™Ö', score: 5 }, right: { count: '4Î™Ö', score: 25 } },
    { left: { count: '1Î™Ö', score: 10 }, right: { count: '5Î™Ö', score: 30 } },
    { left: { count: '2Î™Ö', score: 15 }, right: { count: '6Î™Ö Ïù¥ÏÉÅ', score: 35 } },
    { left: { count: '3Î™Ö', score: 20 }, right: { count: '', score: null } },
]

const accountTable = [
    { left: { range: '6Í∞úÏõî ÎØ∏Îßå', score: 1 }, right: { range: '8ÎÖÑ Ïù¥ÏÉÅ ~ 9ÎÖÑ ÎØ∏Îßå', score: 10 } },
    {
        left: { range: '6Í∞úÏõî Ïù¥ÏÉÅ ~ 1ÎÖÑ ÎØ∏Îßå', score: 2 },
        right: { range: '9ÎÖÑ Ïù¥ÏÉÅ ~ 10ÎÖÑ ÎØ∏Îßå', score: 11 },
    },
    {
        left: { range: '1ÎÖÑ Ïù¥ÏÉÅ ~ 2ÎÖÑ ÎØ∏Îßå', score: 3 },
        right: { range: '10ÎÖÑ Ïù¥ÏÉÅ ~ 11ÎÖÑ ÎØ∏Îßå', score: 12 },
    },
    {
        left: { range: '2ÎÖÑ Ïù¥ÏÉÅ ~ 3ÎÖÑ ÎØ∏Îßå', score: 4 },
        right: { range: '11ÎÖÑ Ïù¥ÏÉÅ ~ 12ÎÖÑ ÎØ∏Îßå', score: 13 },
    },
    {
        left: { range: '3ÎÖÑ Ïù¥ÏÉÅ ~ 4ÎÖÑ ÎØ∏Îßå', score: 5 },
        right: { range: '12ÎÖÑ Ïù¥ÏÉÅ ~ 13ÎÖÑ ÎØ∏Îßå', score: 14 },
    },
    {
        left: { range: '4ÎÖÑ Ïù¥ÏÉÅ ~ 5ÎÖÑ ÎØ∏Îßå', score: 6 },
        right: { range: '13ÎÖÑ Ïù¥ÏÉÅ ~ 14ÎÖÑ ÎØ∏Îßå', score: 15 },
    },
    {
        left: { range: '5ÎÖÑ Ïù¥ÏÉÅ ~ 6ÎÖÑ ÎØ∏Îßå', score: 7 },
        right: { range: '14ÎÖÑ Ïù¥ÏÉÅ ~ 15ÎÖÑ ÎØ∏Îßå', score: 16 },
    },
    { left: { range: '6ÎÖÑ Ïù¥ÏÉÅ ~ 7ÎÖÑ ÎØ∏Îßå', score: 8 }, right: { range: '15ÎÖÑ Ïù¥ÏÉÅ', score: 17 } },
    { left: { range: '7ÎÖÑ Ïù¥ÏÉÅ ~ 8ÎÖÑ ÎØ∏Îßå', score: 9 }, right: { range: '', score: null } },
]

// ÌïòÏù¥ÎùºÏù¥Ìä∏ ÌÅ¥ÎûòÏä§
function highlightClass(type, score) {
    if (type === 'noHouse' && score === noHouseScore.value)
        return 'bg-blue-100 text-blue-600 font-bold'
    if (type === 'family' && score === familyScore.value)
        return 'bg-blue-100 text-blue-600 font-bold'
    if (type === 'account' && score === accountScore.value)
        return 'bg-blue-100 text-blue-600 font-bold'
    return ''
}

function goHome() {
    router.push('/home')
}
function goInfo() {
    router.push('/score/info')
}
</script>

<style scoped>
.fade-enter-active,
.fade-leave-active {
    transition: opacity 0.2s;
}
.fade-enter-from,
.fade-leave-to {
    opacity: 0;
}
</style>
